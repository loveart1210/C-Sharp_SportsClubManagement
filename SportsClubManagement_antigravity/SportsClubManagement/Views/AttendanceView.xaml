<UserControl x:Class="SportsClubManagement.Views.AttendanceView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             mc:Ignorable="d"
             d:DesignHeight="600" d:DesignWidth="900"
             Loaded="UserControl_Loaded">
    <UserControl.Resources>
        <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>
    </UserControl.Resources>

    <Grid Margin="10">
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="300"/>
            <ColumnDefinition Width="*"/>
        </Grid.ColumnDefinitions>

        <!-- Left: Calendar & Session Selection -->
        <Border BorderBrush="#DDD" BorderThickness="0,0,1,0" Padding="10">
            <StackPanel>
                <Button Content="Manual Refresh" Click="Button_Click" Margin="0,0,0,10"/>
                <TextBlock Text="Chọn Ngày" FontWeight="Bold" Margin="0,0,0,10"/>
                <Calendar SelectedDate="{Binding SelectedDate}" Margin="0,0,0,20"/>
                
                <TextBlock Text="Chọn Buổi Tập" FontWeight="Bold" Margin="0,0,0,10"/>
                
                <!-- Debug Info -->
                <TextBlock Text="{Binding Sessions.Count, StringFormat='Found: {0}'}" Foreground="Red" Margin="0,0,0,5"/>

                <ComboBox ItemsSource="{Binding Sessions}" SelectedItem="{Binding SelectedSession}" 
                          Margin="0,0,0,20" Padding="5">
                    <ComboBox.ItemTemplate>
                        <DataTemplate>
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="{Binding Name}" FontWeight="Bold"/>
                                <TextBlock Text="{Binding StartTime, StringFormat=' ({0:HH:mm})'}" />
                            </StackPanel>
                        </DataTemplate>
                    </ComboBox.ItemTemplate>
                </ComboBox>
                
                <TextBlock Text="Thống kê" FontWeight="Bold" Margin="0,0,0,10"/>
                <TextBlock Text="{Binding AttendanceSummary}" FontStyle="Italic" Foreground="Gray"/>
            </StackPanel>
        </Border>

        <!-- Right: Member Attendance List -->
        <Grid Grid.Column="1" Margin="10">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>
            
            <TextBlock Text="{Binding HeaderText}" FontSize="18" FontWeight="Bold" Margin="0,0,0,10"/>
            
            <DataGrid Grid.Row="1" ItemsSource="{Binding AttendanceRecords}" AutoGenerateColumns="False" 
                      CanUserAddRows="False" IsReadOnly="False" BorderBrush="#EEE">
                <DataGrid.Columns>
                    <DataGridTextColumn Header="Tên thành viên" Binding="{Binding UserName}" Width="200" IsReadOnly="True"/>
                    <DataGridTextColumn Header="Vai trò" Binding="{Binding Role}" Width="100" IsReadOnly="True"/>
                    
                    <!-- Attendance Checkbox (Editable by Founder/Coach only) -->
                    <DataGridTemplateColumn Header="Có mặt" Width="80">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <CheckBox IsChecked="{Binding IsPresent, UpdateSourceTrigger=PropertyChanged}" 
                                          HorizontalAlignment="Center"
                                          IsEnabled="{Binding DataContext.IsFounderOrCoach, RelativeSource={RelativeSource AncestorType=UserControl}}"/>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>
                    
                    <DataGridTextColumn Header="Ghi chú" Binding="{Binding Note, UpdateSourceTrigger=PropertyChanged}" Width="*">
                         <DataGridTextColumn.ElementStyle>
                            <Style TargetType="TextBlock">
                                 <!-- Only Editable if Founder/Coach? DataGridTextColumn is tricky with conditional IsReadOnly. 
                                      Better to use TemplateColumn for conditional editing or just handle in setter. 
                                      For simplicity, let's keep it editable but disabled if not authorized? 
                                      Actually DataGrid doesn't support binding IsReadOnly on row/cell level easily.
                                      Let's switch to TemplateColumn for Note if we want to restrict editing. -->
                            </Style>
                        </DataGridTextColumn.ElementStyle>
                        <DataGridTextColumn.EditingElementStyle>
                             <Style TargetType="TextBox">
                                 <Setter Property="IsEnabled" Value="{Binding DataContext.IsFounderOrCoach, RelativeSource={RelativeSource AncestorType=UserControl}}"/>
                             </Style>
                        </DataGridTextColumn.EditingElementStyle>
                    </DataGridTextColumn>
                </DataGrid.Columns>
            </DataGrid>

            <!-- Save Button (Founder/Coach Only) -->
            <StackPanel Grid.Row="2" Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,10,0,0"
                        Visibility="{Binding IsFounderOrCoach, Converter={StaticResource BooleanToVisibilityConverter}}">
                <Button Content="Lưu Điểm Danh" Command="{Binding SaveAttendanceCommand}" 
                        Background="#4CAF50" Foreground="White" Padding="15,10" BorderThickness="0"/>
            </StackPanel>
        </Grid>
    </Grid>
</UserControl>
